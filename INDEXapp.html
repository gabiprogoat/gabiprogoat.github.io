<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>V-GO Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {margin:0; font-family:system-ui,sans-serif; background:#f1f3f6;}
header {padding:14px; background:#111827; color:white; text-align:center; font-size:1.1rem;}
.container {padding:12px; display:grid; grid-template-columns:1fr; gap:14px;}
.card {background:white; border-radius:16px; padding:14px; box-shadow:0 4px 14px rgba(0,0,0,.08);}
.kpi {text-align:center; font-size:clamp(1.8rem,6vw,2.4rem); font-weight:700;}
.task-list {margin-top:10px;}
.task-item {display:inline-block; padding:4px 8px; margin:2px 2px 2px 0; border-radius:6px; color:white; font-weight:500; font-size:0.85rem;}
.sin-comenzar {background:#dc2626;}
.pendiente {background:#f59e0b;}
.completadas {background:#16a34a;}
.chart-container {position:relative; width:100%; height:260px;}
.task-input {margin-top:10px; display:flex; gap:6px;}
.task-input input {flex:1; padding:4px 8px; border-radius:6px; border:1px solid #ccc;}
.task-input button {padding:4px 10px; border:none; border-radius:6px; background:#2563eb; color:white; cursor:pointer;}
.task-input button:hover {background:#1d4ed8;}
@media (min-width:768px){.container{grid-template-columns:repeat(2,1fr);}.chart-container{height:320px;}}
</style>
</head>
<body>

<header>V-GO Soporte Papuuuu</header>

<div class="container" id="dashboard-container">
  <!-- Gráficos globales -->
  <div class="card"><div class="chart-container"><canvas id="donut"></canvas></div></div>
  <div class="card"><div class="chart-container"><canvas id="bars"></canvas></div></div>
</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQDnVk25Z6U5952Acd06WnYKTOOA-BF8cYrUYn83Lcbw1Y68d_TzOsCBkAZnYgyskysf9v3oUl266u-/pub?output=csv";
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyeu0lLHxeAy66P2mmVUVEnRSZRi4pxqV8W8rQ6KMIxNu8scgOoiH-UTeDVvixIw19y/exec";

function parseCSV(text){
  let delimiter = text.includes("\t") ? "\t" : ","; 
  const lines = text.split(/\r?\n/).filter(l=>l.trim()!=="");
  const headers = lines[0].split(delimiter).map(h=>h.replace(/^"|"$/g,"").trim());
  const rows = lines.slice(1).map(line=>line.split(delimiter).map(c=>c.replace(/^"|"$/g,"").trim()));
  return { headers, rows };
}

fetch(SHEET_URL)
.then(r=>r.text())
.then(csv=>{
  const { headers, rows } = parseCSV(csv);
  const container = document.getElementById("dashboard-container");

  const taskPairs = [];
  for(let i=0;i<headers.length;i++){
    const h = headers[i];
    if(h.includes("(C)") || /Datos/i.test(h)) continue;
    if(i+1 < headers.length && headers[i+1].toLowerCase().includes("estado")){
      taskPairs.push({ taskColIndex:i, taskColName:h, statusColIndex:i+1 });
      i++;
    }
  }

  if(taskPairs.length===0){ alert("No se detectaron columnas de tareas."); return; }

  let globalCounts = { completadas:0, pendientes:0, sinComenzar:0 };

  taskPairs.forEach(pair=>{
    const tasks=[];
    let counts={ completadas:0, pendientes:0, sinComenzar:0 };

    rows.forEach(row=>{
      const name = row[pair.taskColIndex];
      if(!name) return;

      const s = (row[pair.statusColIndex]||"").trim();
      let status="Sin Comenzar";
      if(/Completado/i.test(s)) status="Completadas";
      else if(/Pendiente/i.test(s)) status="Pendiente";

      tasks.push({name,status});

      if(status==="Completadas") counts.completadas++;
      else if(status==="Pendiente") counts.pendientes++;
      else counts.sinComenzar++;
    });

    globalCounts.completadas += counts.completadas;
    globalCounts.pendientes += counts.pendientes;
    globalCounts.sinComenzar += counts.sinComenzar;

    const total = counts.completadas + counts.pendientes + counts.sinComenzar;
    const percent = total ? Math.round(counts.completadas/total*100) : 0;

    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `<div class="kpi"><strong>${percent}%</strong></div>
                      <span>${pair.taskColName}</span>
                      <div class="task-list"></div>`;
    container.appendChild(card);

    const taskList = card.querySelector(".task-list");
    ["Sin Comenzar","Pendiente","Completadas"].forEach(status=>{
      tasks.filter(t=>t.status===status).forEach(task=>{
        const span = document.createElement("span");
        span.className="task-item "+status.toLowerCase().replace(" ","-");
        span.innerText = task.name;
        taskList.appendChild(span);
      });
    });

    const taskInputDiv = document.createElement("div");
    taskInputDiv.className="task-input";
    taskInputDiv.innerHTML = `<input type="text" placeholder="Nueva tarea..." class="new-task-name">
                              <button class="add-task-btn">Agregar tarea</button>`;
    card.appendChild(taskInputDiv);

    const button = taskInputDiv.querySelector(".add-task-btn");
    const input = taskInputDiv.querySelector(".new-task-name");

    button.addEventListener("click", ()=>{
      const name = input.value.trim();
      if(!name) return alert("Escribí un nombre para la tarea.");

      fetch(WEB_APP_URL, {
        method:"POST",
        body: JSON.stringify({ columnName: pair.taskColName, taskName: name }),
        headers: {"Content-Type":"application/json"}
      })
      .then(r=>r.text()) // <-- cambiar de .json() a .text()
      .then(text=>{
        let res;
        try{ res = JSON.parse(text); }catch(e){ res={success:false,error:"Respuesta inválida"} }

        alert(res.success ? "Tarea agregada con éxito!" : (res.error||"Error al agregar la tarea"));
        input.value=""; // siempre vacía el input
        if(res.success) location.reload();
      })
      .catch(err=>{
        console.error(err);
        alert("Error al conectar con la Web App");
        input.value="";
      });
    });

  });

  // Gráficos globales
  new Chart(document.getElementById("donut"), {
    type:"doughnut",
    data:{
      labels:["Completadas","Pendientes","Sin comenzar"],
      datasets:[{ data:[globalCounts.completadas, globalCounts.pendientes, globalCounts.sinComenzar],
                  backgroundColor:["#16a34a","#f59e0b","#dc2626"] }]
    },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:"bottom"}} }
  });

  new Chart(document.getElementById("bars"), {
    type:"bar",
    data:{
      labels:["Completadas","Pendientes","Sin comenzar"],
      datasets:[{ data:[globalCounts.completadas, globalCounts.pendientes, globalCounts.sinComenzar] }]
    },
    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
  });

});
</script>

</body>
</html>
