<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Análisis de datos</title>

<style>
body{margin:0;font-family:system-ui,sans-serif;background:#f1f3f6;}
header{background:#111827;color:white;padding:14px;text-align:center;}
.container{padding:14px;display:grid;gap:14px;}
.card{background:white;border-radius:14px;padding:14px;box-shadow:0 4px 14px rgba(0,0,0,.08);}
select,input,button{padding:6px 8px;border-radius:6px;border:1px solid #ccc;}
button{background:#2563eb;color:white;border:none;cursor:pointer;}
button:hover{background:#1d4ed8;}
.result{font-size:.9rem;border-bottom:1px solid #eee;padding:6px 0;}
.back{color:#2563eb;text-decoration:none;font-weight:600;}
</style>
</head>

<body>
<header>Análisis de datos</header>

<div class="container">

<div class="card">
  <a href="index.html" class="back">← Volver</a>
</div>

<div class="card">
  <h3>Añadir Google Sheet (público)</h3>
  <input id="sheetUrl" placeholder="URL del Google Sheet">
  <button onclick="addDocument()">Añadir</button>
</div>

<div class="card">
  <h3>Selección A</h3>
  <select id="docA" onchange="loadSheets('A')"></select>
  <select id="sheetA" onchange="loadColumns('A')"></select>
  <select id="colA"></select>
</div>

<div class="card">
  <h3>Selección B</h3>
  <select id="docB" onchange="loadSheets('B')"></select>
  <select id="sheetB" onchange="loadColumns('B')"></select>
  <select id="colB"></select>
</div>

<div class="card">
  <button onclick="analyze()">Analizar</button>
</div>

<div class="card">
  <h3>Resultado</h3>
  <div id="results"></div>
</div>

</div>

<script>
/* =========================
   STORAGE
========================= */
const documents = JSON.parse(localStorage.getItem("gs_docs") || "[]");
function saveDocs(){localStorage.setItem("gs_docs", JSON.stringify(documents));}

/* =========================
   HELPERS
========================= */
function extractId(url){
  const m = url.match(/\/d\/([^\/]+)/);
  return m ? m[1] : null;
}

function parseNumber(v){
  if(!v) return NaN;
  v=v.toString().replace(/[^\d.,-]/g,"");
  if(v.includes(",") && v.includes(".")){
    v=v.lastIndexOf(",")>v.lastIndexOf(".")?v.replace(/\./g,"").replace(",","."):v.replace(/,/g,"");
  } else if(v.includes(",")){
    v=v.replace(",",".");
  }
  return parseFloat(v);
}

/* =========================
   LOAD DOCUMENT
========================= */
function addDocument(){
  const url=document.getElementById("sheetUrl").value.trim();
  const id=extractId(url);
  if(!id) return alert("URL inválida");

  if(documents.find(d=>d.id===id)) return;

  fetch(`https://docs.google.com/spreadsheets/d/${id}/edit`)
    .then(r=>r.text())
    .then(html=>{
      const matches=[...html.matchAll(/"gid":(\d+),"title":"([^"]+)"/g)];
      if(!matches.length) throw "No sheets";

      const sheets=matches.map(m=>({gid:m[1],title:m[2]}));
      documents.push({id,url,sheets,data:{}});
      saveDocs();
      updateDocs();
      document.getElementById("sheetUrl").value="";
    })
    .catch(()=>{
      alert("No se pudieron leer las hojas. Verificá que el Sheet sea público.");
    });
}

function updateDocs(){
  ["A","B"].forEach(t=>{
    const s=document.getElementById("doc"+t);
    s.innerHTML="";
    documents.forEach((d,i)=>s.add(new Option(`Doc ${i+1}`,i)));
    loadSheets(t);
  });
}

function loadSheets(t){
  const d=documents[document.getElementById("doc"+t).value];
  const s=document.getElementById("sheet"+t);
  s.innerHTML="";
  d.sheets.forEach(sh=>s.add(new Option(sh.title,sh.gid)));
  loadColumns(t);
}

function loadColumns(t){
  const d=documents[document.getElementById("doc"+t).value];
  const gid=document.getElementById("sheet"+t).value;
  const key=d.id+"_"+gid;

  if(d.data[key]){
    fillCols(t,d.data[key].headers);
    return;
  }

  fetch(`https://docs.google.com/spreadsheets/d/${d.id}/export?format=csv&gid=${gid}`)
    .then(r=>r.text())
    .then(csv=>{
      const lines=csv.split(/\r?\n/).filter(l=>l);
      const headers=lines[0].split(",");
      const rows=lines.slice(1).map(l=>l.split(","));
      d.data[key]={headers,rows};
      saveDocs();
      fillCols(t,headers);
    });
}

function fillCols(t,headers){
  const c=document.getElementById("col"+t);
  c.innerHTML="";
  headers.forEach((h,i)=>c.add(new Option(h,i)));
}

/* =========================
   ANALYZE
========================= */
function analyze(){
  const dA=documents[docA.value];
  const dB=documents[docB.value];
  const rA=dA.data[dA.id+"_"+sheetA.value].rows;
  const rB=dB.data[dB.id+"_"+sheetB.value].rows;

  const out=document.getElementById("results");
  out.innerHTML="";
  const max=Math.max(rA.length,rB.length);

  for(let i=1;i<max;i++){
    const vA=rA[i]?.[colA.value]||"";
    const vB=rB[i]?.[colB.value]||"";

    const nA=parseNumber(vA), nB=parseNumber(vB);
    const a=!isNaN(nA), b=!isNaN(nB);

    let r;
    if(a&&b) r=nA>nB?"A mayor":nB>nA?"B mayor":"Iguales";
    else if(a) r="A numérico";
    else if(b) r="B numérico";
    else r=vA.length>vB.length?"A más letras":vB.length>vA.length?"B más letras":"Iguales";

    out.innerHTML+=`<div class="result">Fila ${i+1}: ${r}</div>`;
  }
}

updateDocs();
</script>
</body>
</html>
